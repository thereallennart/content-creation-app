<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Creation App</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>
    <!-- Include Quill stylesheet -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Include Quill library -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/turndown/dist/turndown.min.js"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="images/logo.png" alt="Logo" class="logo">
            <h1>Content Creation App</h1>
        </div>
    </header>
    <!-- Tabs with full-width background -->
    <div class="tabs">
        <div class="tabs-container">
            <button class="tab-button active" data-tab="input">Input</button>
            <button class="tab-button" data-tab="output">Output</button>
        </div>
    </div>
    <main>
        <div id="input" class="tab-content active">
            <div id="inputSection">
                <!-- Long Form Content Input -->
                <h2>Step 1: Create Product Newsletter</h2>
                <div id="editor-container"></div>
                <button id="saveLongFormBtn" class="button-primary" onclick="saveLongFormContent()">Save Newsletter to ClickUp</button>

                <!-- Short Form Content Section -->
                <h2>Step 2: Create short form content</h2>
                <div class="content-selection-container">
                    <!-- Predefined Short Form Content Type Selection -->
                    <label>Select Short Form Content Types:</label><br>
                    <div class="post-type-buttons">
                        <button type="button" class="post-type-button" data-type="Linkedin Post">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.761 0 5-2.239 5-5v-14c0-2.761-2.239-5-5-5zm-11 19h-3v-10h3v10zm-1.5-11.268c-.966 0-1.75-.784-1.75-1.75s.784-1.75 1.75-1.75 1.75.784 1.75 1.75-.784 1.75-1.75 1.75zm13.5 11.268h-3v-5.5c0-1.381-1.119-2.5-2.5-2.5s-2.5 1.119-2.5 2.5v5.5h-3v-10h3v1.5c.69-1.19 2.019-2 3.5-2 2.481 0 4.5 2.019 4.5 4.5v6.5z"/>
                            </svg>
                            <span>Linkedin Post</span>
                        </button>
                        <button type="button" class="post-type-button" data-type="Video Demo Script">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M17 10.5v-6.5c0-1.104-.896-2-2-2h-10c-1.104 0-2 .896-2 2v12c0 1.104.896 2 2 2h10c1.104 0 2-.896 2-2v-6.5l5 5v-11l-5 5zm-2 7.5h-10v-12h10v12z"/>
                            </svg>
                            <span>Video Demo Script</span>
                        </button>
                        <button type="button" class="post-type-button" data-type="Changelog">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm0 22c-5.514 0-10-4.486-10-10s4.486-10 10-10 10 4.486 10 10-4.486 10-10 10zm-1-15h-2v6h6v-2h-4v-4z"/>
                            </svg>
                            <span>Changelog</span>
                        </button>
                        <button type="button" class="post-type-button" data-type="Slack message">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M5.5 15c-.828 0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h1.5v-3h-1.5zm0-3h1.5v-3h-1.5c-.828 0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5zm3 3h3v-3h-3v3zm0-6h3v-3h-3v3zm3 3h3v-3h-3v3zm3 3h1.5c.828 0 1.5-.672 1.5-1.5s-.672-1.5-1.5-1.5h-1.5v3zm0-6h1.5c.828 0 1.5-.672 1.5-1.5s-.672-1.5-1.5-1.5h-1.5v3zm-6 6h-1.5c-.828 0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h1.5v-3zm6 0h3v-3h-3v3zm0-6h3v-3h-3v3z"/>
                            </svg>
                            <span>Slack message</span>
                        </button>
                        <button type="button" class="post-type-button" data-type="Intro for Blog Post">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm0 22c-5.514 0-10-4.486-10-10s4.486-10 10-10 10 4.486 10 10-4.486 10-10 10zm-1-15h-2v6h6v-2h-4v-4z"/>
                            </svg>
                            <span>Intro for Blog Post</span>
                        </button>
                    </div><br>

                    <!-- Custom Content Type Inputs -->
                    <label>Add Custom Content Types:</label><br>
                    <div id="customContentTypes"></div>
                    <button id="addMoreBtn" class="button-secondary" onclick="addCustomContentType()">Add</button><br><br>
                </div>

                <!-- Submit Button -->
                <button id="submitBtn" class="button-primary" onclick="submitContent()">Create Short Form Content</button><br><br>
            </div>

            <!-- Status Indicator -->
            <div id="loadingIndicator" style="display: none;">
                <div class="spinner"></div>
                <div id="loadingText">Content sent</div>
            </div>
        </div>
        <div id="output" class="tab-content">
            <!-- Editable Short Form Content Display -->
            <div id="results"></div>

            <!-- Save to Google Docs Button -->
            <button id="saveBtn" class="button-primary" onclick="saveToDocs()" style="display:none;">Save to ClickUp</button><br><br>

            <!-- Past Generations Container -->
            <h2>Past Generations</h2>
            <div id="pastGenerations"></div>
        </div>
    </main>

    <script>
        let customTypeCount = 0;
        let quill; // Declare quill in a wider scope

        // Function to add a new custom content type input
        function addCustomContentType() {
            const customContainer = document.getElementById('customContentTypes');
            const wrapper = document.createElement('div');
            wrapper.className = 'custom-type-wrapper';
            wrapper.id = `customTypeWrapper${customTypeCount}`;

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Enter custom content type';
            input.id = `customType${customTypeCount}`;
            input.classList.add('custom-type-input');

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.onclick = function() {
                customContainer.removeChild(wrapper);
            };

            wrapper.appendChild(input);
            wrapper.appendChild(deleteBtn);
            customContainer.appendChild(wrapper);
            customTypeCount++;
        }

        function switchToTab(tabName) {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            contents.forEach(content => {
                if (content.id === tabName) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        function submitContent() {
            const longFormContent = quill.root.innerHTML; // Get content from Quill
            const selectedTypes = [];

            // Collect selected post types from active buttons
            document.querySelectorAll('.post-type-button.active').forEach(button => {
                const type = button.getAttribute('data-type');
                if (type) {
                    selectedTypes.push(type); // Only push the type, not the prompt
                }
            });

            // Collect custom content types
            const customInputs = document.getElementsByClassName('custom-type-input');
            for (let i = 0; i < customInputs.length; i++) {
                const customValue = customInputs[i].value.trim();
                if (customValue) {
                    const confirmAdd = confirm(`Are you sure you want to include "${customValue}" as a custom content type?`);
                    if (confirmAdd) {
                        selectedTypes.push(customValue); // Only push the custom type
                    }
                }
            }

            // Check if there are any selected types
            if (selectedTypes.length === 0) {
                alert('Please select at least one content type.');
                return;
            }

            // Retrieve token and timestamp from local storage
            const token = localStorage.getItem('token');
            const tokenTimestamp = localStorage.getItem('tokenTimestamp');
            const currentTime = new Date().getTime();

            // Check if the token is still valid (30 minutes = 1800000 ms)
            if (!token || currentTime - tokenTimestamp > 1800000) {
                alert('Your session has expired. Please log in again.');
                window.location.href = 'index.html';
                return;
            }

            // Hide input section and show loading indicator
            document.getElementById('inputSection').style.display = 'none';
            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadingText = document.getElementById('loadingText');
            loadingIndicator.style.display = 'flex';

            // Cycle through loading messages
            const messages = ["Content sent", "Magic happening", "Packaging"];
            let messageIndex = 0;
            const messageInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % messages.length;
                loadingText.textContent = messages[messageIndex];
            }, 1000);

            // Trigger webhook with token and content types
            const webhookUrl = 'https://hook.eu1.make.com/5y3ekautp96feqn5rcv3gg9tysi10jx0'; // Replace with your webhook URL
            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` // Include token in Authorization header
                },
                body: JSON.stringify({
                    longContent: longFormContent,
                    types: selectedTypes // Only send the types
                })
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(messageInterval);
                loadingIndicator.style.display = 'none';
                document.getElementById('inputSection').style.display = 'block';

                document.getElementById('results').innerHTML = '';

                // Save generation to local storage
                const timestamp = new Date().toISOString();
                const generation = { timestamp, data };
                let pastGenerations = JSON.parse(localStorage.getItem('pastGenerations')) || [];
                pastGenerations.unshift(generation);
                localStorage.setItem('pastGenerations', JSON.stringify(pastGenerations));

                displayResults(data);
                updatePastGenerations();

                // Show Save to Google Docs button
                document.getElementById('saveBtn').style.display = 'block';

                // Automatically switch to the output tab
                switchToTab('output');

                // Trigger emoji confetti animation
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    shapes: ['text'],
                    scalar: 1.2,
                    ticks: 200,
                    gravity: 0.5,
                    drift: 0,
                    text: {
                        value: ['ðŸŽ‰', 'âœ¨', 'ðŸŽˆ', 'ðŸŽŠ'], // Array of emojis
                        font: 'Arial',
                        style: 'normal',
                        weight: 'bold',
                        size: 20
                    }
                });
            })
            .catch(error => {
                clearInterval(messageInterval);
                loadingIndicator.style.display = 'none';
                document.getElementById('inputSection').style.display = 'block';
                console.error('Error:', error);
            });
        }

        function displayResults(data) {
            // Move the existing result display logic here
            if (Array.isArray(data)) {
                data.forEach((content, index) => {
                    const contentDiv = document.createElement('div');
                    contentDiv.classList.add('content-item');

                    // Change headline from <h3> to <label>
                    const headline = document.createElement('label');
                    headline.textContent = content.type;
                    contentDiv.appendChild(headline);

                    // Render LinkedIn-style preview for LinkedIn posts
                    if (content.type === 'Linkedin Post') {
                        const linkedinPreview = document.createElement('div');
                        linkedinPreview.classList.add('linkedin-preview-container');
                        linkedinPreview.innerHTML = `
                            <div class="linkedin-preview">
                            <div class="linkedin-post">
                                <div class="linkedin-header">
                                    <img src="https://via.placeholder.com/50" alt="Profile Picture" class="linkedin-profile-pic">
                                    <div class="linkedin-header-text">
                                        <p class="linkedin-name">John Doe</p>
                                        <p class="linkedin-title">Dummy Title</p>
                                    </div>
                                </div>
                                <textarea class="linkedin-content" rows="5" cols="50">${content.text}</textarea>
                            </div>
                        `;
                        contentDiv.appendChild(linkedinPreview);
                    } else {
                        const textarea = document.createElement('textarea');
                        textarea.id = `editedContent${index}`;
                        textarea.rows = 5;
                        textarea.cols = 50;
                        textarea.value = content.text;
                        contentDiv.appendChild(textarea);
                    }

                    document.getElementById('results').appendChild(contentDiv);
                });
            } else {
                document.getElementById('status').textContent = 'Invalid response format';
            }
        }

        function updatePastGenerations() {
            const pastGenerationsContainer = document.getElementById('pastGenerations');
            pastGenerationsContainer.innerHTML = '';
            const pastGenerations = JSON.parse(localStorage.getItem('pastGenerations')) || [];

            pastGenerations.forEach((generation, index) => {
                const generationItem = document.createElement('div');
                generationItem.classList.add('past-generation-item');
                generationItem.textContent = new Date(generation.timestamp).toLocaleString();
                generationItem.onclick = () => displayResults(generation.data);
                pastGenerationsContainer.appendChild(generationItem);
            });
        }

        // Add this new function for tab switching
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
        }

        window.onload = function() {
            updatePastGenerations();
            setupTabs();
        };

        document.querySelectorAll('.post-type-button').forEach(button => {
            button.addEventListener('click', () => {
                button.classList.toggle('active');
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            quill = new Quill('#editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']  // Remove formatting button
                    ]
                }
            });

            // Load saved content from local storage
            const savedContent = localStorage.getItem('quillContent');
            if (savedContent) {
                quill.root.innerHTML = savedContent;
            }

            // Save content to local storage on text change
            quill.on('text-change', function() {
                const currentContent = quill.root.innerHTML;
                localStorage.setItem('quillContent', currentContent);
            });
        });

        function saveToDocs() {
            const webhookUrl = 'https://hook.eu1.make.com/mc48y83lnmqsc6ktg1xidp8omiqwlnq4'; // Webhook URL

            // Collect generated posts' content and type
            const resultsContainer = document.getElementById('results');
            const contentItems = resultsContainer.querySelectorAll('.content-item');
            const postsData = Array.from(contentItems).map(item => {
                const typeElement = item.querySelector('label'); // Assuming the type is in a <label> tag
                const contentElement = item.querySelector('textarea'); // Assuming the content is in a <textarea>

                // Check if both elements exist
                if (typeElement && contentElement) {
                    const type = typeElement.textContent;
                    const content = contentElement.value;
                    return { type, content };
                } else {
                    console.error('Missing type or content element in content item:', item);
                    return null; // Return null if elements are missing
                }
            }).filter(post => post !== null); // Filter out any null entries

            // Send the collected data to the webhook
            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ posts: postsData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Content successfully saved to ClickUp!');
                } else {
                    alert('Failed to save content. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving content.');
            });
        }

        function saveLongFormContent() {
            const webhookUrl = 'https://hook.eu1.make.com/mc48y83lnmqsc6ktg1xidp8omiqwlnq4'; // Webhook URL for saving

            // Get the HTML content from Quill
            const longFormHtmlContent = quill.root.innerHTML;

            // Convert HTML to markdown using Turndown
            const turndownService = new TurndownService();
            const longFormMarkdownContent = turndownService.turndown(longFormHtmlContent);

            // Prepare the data to send
            const data = {
                posts: [{
                    type: 'Product Newsletter',
                    content: longFormMarkdownContent
                }]
            };

            // Send the long-form content to the webhook
            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Long form content successfully saved to ClickUp!');
                } else {
                    alert('Failed to save long form content. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving long form content.');
            });
        }
    </script>
</body>
</html>